https://mp.weixin.qq.com/s/TmYbXOAaZYIYupK9lNwUig

å®ç°Webç«¯æŒ‡çº¹ç™»å½•
å‰è¨€
ç°åœ¨è¶Šæ¥è¶Šå¤šçš„ç¬”è®°æœ¬ç”µè„‘å†…ç½®äº†æŒ‡çº¹è¯†åˆ«ï¼Œç”¨äºå¿«é€Ÿä»é”å±è¿›å…¥æ¡Œé¢ï¼Œä¸€äº›å®¢æˆ·ç«¯çš„è½¯ä»¶ä¹Ÿæ”¯æŒé€šè¿‡æŒ‡çº¹æ¥è®¤è¯ç”¨æˆ·èº«ä»½ã€‚

å‰å‡ å¤©æˆ‘åœ¨æƒ³ï¼Œæ—¢ç„¶å®¢æˆ·ç«¯è½¯ä»¶èƒ½è°ƒç”¨æŒ‡çº¹è®¾å¤‡ï¼Œwebç«¯åº”è¯¥ä¹Ÿå¯ä»¥è°ƒç”¨ï¼Œç»è¿‡ä¸€ç•ªæŠ˜è…¾åï¼Œç»ˆäºå®ç°äº†è¿™ä¸ªåŠŸèƒ½ï¼Œå¹¶åº”ç”¨åœ¨äº†æˆ‘çš„å¼€æºé¡¹ç›®ä¸­ã€‚

æœ¬æ–‡å°±è·Ÿå¤§å®¶åˆ†äº«ä¸‹æˆ‘çš„å®ç°æ€è·¯ä»¥åŠè¿‡ç¨‹ï¼Œæ¬¢è¿å„ä½æ„Ÿå…´è¶£çš„å¼€å‘è€…é˜…è¯»æœ¬æ–‡ã€‚

å®ç°æ€è·¯
æµè§ˆå™¨æä¾›äº†Web Authentication API, æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™å¥—APIæ¥è°ƒç”¨ç”¨æˆ·çš„æŒ‡çº¹è®¾å¤‡æ¥å®ç°ç”¨æˆ·ä¿¡æ¯è®¤è¯ã€‚

æœ€ç»ˆçš„å®ç°æ•ˆæœè§†é¢‘ï¼Œè¯·ç§»æ­¥ï¼šwebç«¯æŒ‡çº¹ç™»å½•

æ³¨å†ŒæŒ‡çº¹
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ‹¿åˆ°æœåŠ¡ç«¯è¿”å›çš„ç”¨æˆ·å‡­è¯ï¼Œéšåå°†ç”¨æˆ·å‡­è¯ä¼ ç»™æŒ‡çº¹è®¾å¤‡ï¼Œè°ƒèµ·ç³»ç»Ÿçš„æŒ‡çº¹è®¤è¯ï¼Œè®¤è¯é€šè¿‡åï¼Œå›è°ƒå‡½æ•°ä¼šè¿”å›è®¾å¤‡idä¸å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™äº›ä¿¡æ¯ä¿å­˜åœ¨æœåŠ¡ç«¯ï¼Œç”¨äºåé¢è°ƒç”¨æŒ‡çº¹è®¾å¤‡æ¥éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œä»è€Œå®ç°ç™»å½•ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ€»ç»“ä¸‹æ³¨å†ŒæŒ‡çº¹çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

ç”¨æˆ·ä½¿ç”¨å…¶ä»–æ–¹å¼åœ¨ç½‘ç«™ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡ç«¯è¿”å›ç”¨æˆ·å‡­è¯ï¼Œå°†ç”¨æˆ·å‡­è¯ä¿å­˜åˆ°æœ¬åœ°
æ£€æµ‹å®¢æˆ·ç«¯æ˜¯å¦å­˜åœ¨æŒ‡çº¹è®¾å¤‡
å¦‚æœå­˜åœ¨ï¼Œå°†æœåŠ¡ç«¯è¿”å›çš„ç”¨æˆ·å‡­è¯ä¸ç”¨æˆ·ä¿¡æ¯ä¼ é€’ç»™æŒ‡çº¹æ³¨å†Œå‡½æ•°æ¥åˆ›å»ºæŒ‡çº¹
èº«ä»½è®¤è¯æˆåŠŸï¼Œå›è°ƒå‡½æ•°è¿”å›è®¾å¤‡idä¸å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œå°†è®¾å¤‡idä¿å­˜åˆ°æœ¬åœ°
å°†è®¾å¤‡idä¸å®¢æˆ·ç«¯ä¿¡æ¯å‘é€è‡³æœåŠ¡ç«¯ï¼Œå°†å…¶å­˜å‚¨åˆ°æŒ‡å®šç”¨æˆ·æ•°æ®ä¸­ã€‚
âš ï¸æ³¨æ„ï¼šæ³¨å†ŒæŒ‡çº¹åªèƒ½å·¥ä½œåœ¨ä½¿ç”¨ https è¿æ¥ï¼Œæˆ–æ˜¯ä½¿ç”¨ localhostçš„ç½‘ç«™ä¸­ã€‚

æŒ‡çº¹è®¤è¯
ç”¨æˆ·åœ¨æˆ‘ä»¬ç½‘ç«™æˆæƒæŒ‡çº¹ç™»å½•åï¼Œä¼šå°†ç”¨æˆ·å‡­è¯ä¸è®¾å¤‡idä¿å­˜åœ¨æœ¬åœ°ï¼Œå½“ç”¨æˆ·è¿›å…¥æˆ‘ä»¬ç½‘ç«™æ—¶ï¼Œä¼šä»æœ¬åœ°æ‹¿åˆ°è¿™ä¸¤æ¡æ•°æ®ï¼Œæç¤ºå®ƒæ˜¯å¦éœ€è¦é€šè¿‡æŒ‡çº¹æ¥ç™»å½•ç³»ç»Ÿï¼ŒåŒæ„ä¹‹ååˆ™å°†è®¾å¤‡idä¸ç”¨æˆ·å‡­è¯ä¼ ç»™æŒ‡çº¹è®¾å¤‡ï¼Œè°ƒèµ·ç³»ç»Ÿçš„æŒ‡çº¹è®¤è¯ï¼Œè®¤è¯é€šè¿‡åï¼Œè°ƒç”¨ç™»å½•æ¥å£ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ€»ç»“ä¸‹æŒ‡çº¹è®¤è¯çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

ä»æœ¬åœ°è·å–ç”¨æˆ·å‡­è¯ä¸è®¾å¤‡id
æ£€æµ‹å®¢æˆ·ç«¯æ˜¯å¦å­˜åœ¨æŒ‡çº¹è®¾å¤‡
å¦‚æœå­˜åœ¨ï¼Œå°†ç”¨æˆ·å‡­è¯ä¸è®¾å¤‡idä¼ ç»™æŒ‡çº¹è®¤è¯å‡½æ•°è¿›è¡Œæ ¡éªŒ
èº«ä»½è®¤è¯æˆåŠŸï¼Œè°ƒç”¨ç™»å½•æ¥å£è·å–ç”¨æˆ·ä¿¡æ¯
âš ï¸æ³¨æ„ï¼šæŒ‡çº¹è®¤è¯åªèƒ½å·¥ä½œåœ¨ä½¿ç”¨ https è¿æ¥ï¼Œæˆ–æ˜¯ä½¿ç”¨ localhostçš„ç½‘ç«™ä¸­ã€‚

å®ç°è¿‡ç¨‹
ä¸Šä¸€ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬æ‹æ¸…äº†æŒ‡çº¹ç™»å½•çš„å…·ä½“å®ç°æ€è·¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“çš„å®ç°è¿‡ç¨‹ä¸ä»£ç ã€‚

æœåŠ¡ç«¯å®ç°
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡ç«¯å†™3ä¸ªæ¥å£ï¼šè·å–TouchIDã€æ³¨å†ŒTouchIDã€æŒ‡çº¹ç™»å½•

è·å–TouchID
è¿™ä¸ªæ¥å£ç”¨äºåˆ¤æ–­ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»åœ¨æœ¬ç½‘ç«™æ³¨å†Œäº†æŒ‡çº¹ï¼Œå¦‚æœå·²ç»æ³¨å†Œåˆ™è¿”å›TouchIDåˆ°å®¢æˆ·ç«¯ï¼Œæ–¹ä¾¿ç”¨æˆ·ä¸‹æ¬¡ç™»å½•ã€‚

controllerå±‚ä»£ç å¦‚ä¸‹
    @ApiOperation(value = "è·å–TouchID", notes = "é€šè¿‡ç”¨æˆ·idè·å–æŒ‡çº¹ç™»å½•æ‰€éœ€å‡­æ®")
    @CrossOrigin()
    @RequestMapping(value = "/getTouchID", method = RequestMethod.POST)
    public ResultVO<?> getTouchID(@ApiParam(name = "ä¼ å…¥userId", required = true) @Valid @RequestBody GetTouchIdDto touchIdDto, @RequestHeader(value = "token") String token) {
        JSONObject result = userService.getTouchID(JwtUtil.getUserId(token));
        if (result.getEnum(ResultEnum.class, "code").getCode() == 0) {
            // touchIdè·å–æˆåŠŸ
            return ResultVOUtil.success(result.getString("touchId"));
        }
        // è¿”å›é”™è¯¯ä¿¡æ¯
        return ResultVOUtil.error(result.getEnum(ResultEnum.class, "code").getCode(), result.getEnum(ResultEnum.class, "code").getMessage());
    }
å¤åˆ¶ä»£ç 
æ¥å£å…·ä½“å®ç°ä»£ç å¦‚ä¸‹
    // è·å–TouchID
    @Override
    public JSONObject getTouchID(String userId) {
        JSONObject returnResult = new JSONObject();
        // æ ¹æ®å½“å‰ç”¨æˆ·idä»æ•°æ®åº“æŸ¥è¯¢touchId
        User user = userMapper.getTouchId(userId);
        String touchId = user.getTouchId();
        if (touchId != null) {
           // touchIdå­˜åœ¨
            returnResult.put("code", ResultEnum.GET_TOUCHID_SUCCESS);
            returnResult.put("touchId", touchId);
            return returnResult;
        }
        // touchIdä¸å­˜åœ¨
        returnResult.put("code", ResultEnum.GET_TOUCHID_ERR);
        return returnResult;
    }
å¤åˆ¶ä»£ç 
æ³¨å†ŒTouchID
è¿™ä¸ªæ¥å£ç”¨äºæ¥æ”¶å®¢æˆ·ç«¯æŒ‡çº¹è®¾å¤‡è¿”å›çš„TouchIDä¸å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œå°†è·å–åˆ°çš„ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“çš„æŒ‡å®šç”¨æˆ·ã€‚

controllerå±‚ä»£ç å¦‚ä¸‹
    @ApiOperation(value = "æ³¨å†ŒTouchID", notes = "ä¿å­˜å®¢æˆ·ç«¯è¿”å›çš„touchidç­‰ä¿¡æ¯")
    @CrossOrigin()
    @RequestMapping(value = "/registeredTouchID", method = RequestMethod.POST)
    public ResultVO<?> registeredTouchID(@ApiParam(name = "ä¼ å…¥userId", required = true) @Valid @RequestBody SetTouchIdDto touchIdDto, @RequestHeader(value = "token") String token) {
        JSONObject result = userService.registeredTouchID(touchIdDto.getTouchId(), touchIdDto.getClientDataJson(), JwtUtil.getUserId(token));
        if (result.getEnum(ResultEnum.class, "code").getCode() == 0) {
            // touchIdè·å–æˆåŠŸ
            return ResultVOUtil.success(result.getString("data"));
        }
        // è¿”å›é”™è¯¯ä¿¡æ¯
        return ResultVOUtil.error(result.getEnum(ResultEnum.class, "code").getCode(), result.getEnum(ResultEnum.class, "code").getMessage());
    }
å¤åˆ¶ä»£ç 
æ¥å£å…·ä½“å®ç°ä»£ç å¦‚ä¸‹
    // æ³¨å†ŒTouchID
    @Override
    public JSONObject registeredTouchID(String touchId, String clientDataJson, String userId) {
        JSONObject result = new JSONObject();
        User row = new User();
        row.setTouchId(touchId);
        row.setClientDataJson(clientDataJson);
        row.setUserId(userId);
       // æ ¹æ®userIdæ›´æ–°touchIdä¸å®¢æˆ·ç«¯ä¿¡æ¯
        int updateResult = userMapper.updateTouchId(row);
        if (updateResult>0) {
            result.put("code", ResultEnum.SET_TOUCHED_SUCCESS);
            result.put("data", "touch_idè®¾ç½®æˆåŠŸ");
            return result;
        }
        result.put("code", ResultEnum.SET_TOUCHED_ERR);
        return result;
    }
å¤åˆ¶ä»£ç 
æŒ‡çº¹ç™»å½•
è¿™ä¸ªæ¥å£æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„ç”¨æˆ·å‡­è¯ä¸touchIdï¼Œéšåå°†å…¶å’Œæ•°æ®åº“ä¸­çš„æ•°æ®è¿›è¡Œæ ¡éªŒï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯ã€‚

controllerå±‚ä»£ç å¦‚ä¸‹
    @ApiOperation(value = "æŒ‡çº¹ç™»å½•", notes = "é€šè¿‡touchIdä¸ç”¨æˆ·å‡­è¯ç™»å½•ç³»ç»Ÿ")
    @CrossOrigin()
    @RequestMapping(value = "/touchIdLogin", method = RequestMethod.POST)
    public ResultVO<?> touchIdLogin(@ApiParam(name = "ä¼ å…¥Touch IDä¸ç”¨æˆ·å‡­è¯", required = true) @Valid @RequestBody TouchIDLoginDto touchIDLogin) {
        JSONObject result = userService.touchIdLogin(touchIDLogin.getTouchId(), touchIDLogin.getCertificate());
        return LoginUtil.getLoginResult(result);
    }
å¤åˆ¶ä»£ç 
æ¥å£å…·ä½“å®ç°ä»£ç å¦‚ä¸‹
    // æŒ‡çº¹ç™»å½•
    @Override
    public JSONObject touchIdLogin(String touchId, String certificate) {
        JSONObject returnResult = new JSONObject();
        User row = new User();
        row.setTouchId(touchId);
        row.setUuid(certificate);
        User user = userMapper.selectUserForTouchId(row);
        String userName = user.getUserName();
        String userId = user.getUserId();
        // ç”¨æˆ·åä¸ºnullåˆ™è¿”å›é”™è¯¯ä¿¡æ¯
        if (userName == null) {
            // æŒ‡çº¹è®¤è¯å¤±è´¥
            returnResult.put("code", ResultEnum.TOUCHID_LOGIN_ERR);
            return returnResult;
        }
       // æŒ‡çº¹è®¤è¯æˆåŠŸï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯è‡³å®¢æˆ·ç«¯
       // ... æ­¤å¤„ä»£ç çœç•¥ï¼Œæ ¹æ®è‡ªå·±çš„éœ€è¦è¿”å›ç”¨æˆ·ä¿¡æ¯å³å¯ ...//
       returnResult.put("code", ResultEnum.LOGIN_SUCCESS);
       return returnResult;
    }
å¤åˆ¶ä»£ç 
å‰ç«¯å®ç°
å‰ç«¯éƒ¨åˆ†ï¼Œéœ€è¦å°†ç°æœ‰çš„ç™»å½•é€»è¾‘å’ŒæŒ‡çº¹è®¤è¯ç›¸ç»“åˆï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸¤ä¸ªå‡½æ•°ï¼šæŒ‡çº¹æ³¨å†Œã€æŒ‡çº¹ç™»å½•ã€‚

æŒ‡çº¹æ³¨å†Œ
è¿™ä¸ªå‡½æ•°æˆ‘ä»¬éœ€è¦æ¥æ”¶3ä¸ªå‚æ•°ï¼šç”¨æˆ·åã€ç”¨æˆ·idã€ç”¨æˆ·å‡­è¯ï¼Œæˆ‘ä»¬éœ€è¦è¿™ä¸‰ä¸ªå‚æ•°æ¥è°ƒç”¨æŒ‡çº¹è®¾å¤‡æ¥ç”ŸæˆæŒ‡çº¹ï¼Œå…·ä½“çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š

    touchIDRegistered: async function(
      userName: string,
      userId: string,
      certificate: string
    ) {
      // æ ¡éªŒè®¾å¤‡æ˜¯å¦æ”¯æŒtouchID
      const hasTouchID = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
      if (
        hasTouchID &&
        window.confirm("æ£€æµ‹åˆ°æ‚¨çš„è®¾å¤‡æ”¯æŒæŒ‡çº¹ç™»å½•ï¼Œæ˜¯å¦å¯ç”¨ï¼Ÿ")
      ) {
        // æ›´æ–°æ³¨å†Œå‡­è¯
        this.touchIDOptions.publicKey.challenge = this.base64ToArrayBuffer(
          certificate
        );
        // æ›´æ–°ç”¨æˆ·åã€ç”¨æˆ·id
        this.touchIDOptions.publicKey.user.name = userName;
        this.touchIDOptions.publicKey.user.displayName = userName;
        this.touchIDOptions.publicKey.user.id = this.base64ToArrayBuffer(
          userId
        );
        // è°ƒç”¨æŒ‡çº¹è®¾å¤‡ï¼Œåˆ›å»ºæŒ‡çº¹
        const publicKeyCredential = await navigator.credentials.create(
          this.touchIDOptions
        );
        if (publicKeyCredential && "rawId" in publicKeyCredential) {
          // å°†rowIdè½¬ä¸ºbase64
          const rawId = publicKeyCredential["rawId"];
          const touchId = this.arrayBufferToBase64(rawId);
          const response = publicKeyCredential["response"];
          // è·å–å®¢æˆ·ç«¯ä¿¡æ¯
          const clientDataJSON = this.arrayBufferToString(
            response["clientDataJSON"]
          );
          // è°ƒç”¨æ³¨å†ŒTouchIDæ¥å£
          this.$api.touchIdLogingAPI
            .registeredTouchID({
              touchId: touchId,
              clientDataJson: clientDataJSON
            })
            .then((res: responseDataType<string>) => {
              if (res.code === 0) {
                // ä¿å­˜touchIdç”¨äºæŒ‡çº¹ç™»å½•
                localStorage.setItem("touchId", touchId);
                return;
              }
              alert(res.msg);
            });
        }
      }
    }
å¤åˆ¶ä»£ç 
ä¸Šé¢å‡½æ•°ä¸­åœ¨åˆ›å»ºæŒ‡çº¹æ—¶ï¼Œç”¨åˆ°äº†ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒæ˜¯åˆ›å»ºæŒ‡çº¹å¿…é¡»è¦ä¼ çš„ï¼Œå®ƒçš„å®šä¹‰ä»¥åŠæ¯ä¸ªå‚æ•°çš„è§£é‡Šå¦‚ä¸‹æ‰€ç¤ºï¼š

const touchIDOptions = {
  publicKey: {
    rp: { name: "chat-system" }, // ç½‘ç«™ä¿¡æ¯
    user: {
      name: "", // ç”¨æˆ·å
      id: "", // ç”¨æˆ·id(ArrayBuffer)
      displayName: "" // ç”¨æˆ·å
    },
    pubKeyCredParams: [
      {
        type: "public-key",
        alg: -7 // æ¥å—çš„ç®—æ³•
      }
    ],
    challenge: "", // å‡­è¯(touchIDOptions)
    authenticatorSelection: {
      authenticatorAttachment: "platform"
    }
  }
}
å¤åˆ¶ä»£ç 
ç”±äºtouchIDOptionsä¸­ï¼Œæœ‰çš„å‚æ•°éœ€è¦ArrayBufferç±»å‹ï¼Œæˆ‘ä»¬æ•°æ®åº“ä¿å­˜çš„æ•°æ®æ˜¯base64æ ¼å¼çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®ç°base64ä¸ArrayBufferä¹‹é—´ç›¸äº’è½¬æ¢çš„å‡½æ•°ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

    base64ToArrayBuffer: function(base64: string) {
      const binaryString = window.atob(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes.buffer;
    },
    arrayBufferToBase64: function(buffer: ArrayBuffer) {
      let binary = "";
      const bytes = new Uint8Array(buffer);
      const len = bytes.byteLength;
      for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return window.btoa(binary);
    }
å¤åˆ¶ä»£ç 
æŒ‡çº¹è®¤è¯é€šè¿‡åï¼Œä¼šåœ¨å›è°ƒå‡½æ•°ä¸­è¿”å›å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œæ•°æ®ç±»å‹æ˜¯ArrayBufferï¼Œæ•°æ®åº“éœ€è¦çš„æ ¼å¼æ˜¯stringç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®ç°ArrayBufferè½¬stringçš„å‡½æ•°ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

    arrayBufferToString: function(buffer: ArrayBuffer) {
      let binary = "";
      const bytes = new Uint8Array(buffer);
      const len = bytes.byteLength;
      for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return binary;
    }
å¤åˆ¶ä»£ç 
æ³¨æ„âš ï¸ï¼šç”¨æˆ·å‡­è¯ä¸­ä¸èƒ½åŒ…å« _ å’Œ **-**è¿™ä¸¤ä¸ªå­—ç¬¦ï¼Œå¦åˆ™base64ToArrayBufferå‡½æ•°å°†æ— æ³•æˆåŠŸè½¬æ¢ã€‚

æŒ‡çº¹ç™»å½•
è¿™ä¸ªå‡½æ•°æ¥æ”¶2ä¸ªå‚æ•°ï¼šç”¨æˆ·å‡­è¯ã€è®¾å¤‡idï¼Œæˆ‘ä»¬ä¼šé€šè¿‡è¿™ä¸¤ä¸ªå‚æ•°æ¥è°ƒèµ·å®¢æˆ·ç«¯çš„æŒ‡çº¹è®¾å¤‡æ¥éªŒè¯èº«ä»½ï¼Œå…·ä½“çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š

touchIDLogin: async function(certificate: string, touchId: string) {
      // æ ¡éªŒè®¾å¤‡æ˜¯å¦æ”¯æŒtouchID
      const hasTouchID = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
      if (hasTouchID) {
        // æ›´æ–°ç™»å½•å‡­è¯
        this.touchIDLoginOptions.publicKey.challenge = this.base64ToArrayBuffer(
          certificate
        );
        // æ›´æ–°touchID
        this.touchIDLoginOptions.publicKey.allowCredentials[0].id = this.base64ToArrayBuffer(
          touchId
        );
        // å¼€å§‹æ ¡éªŒæŒ‡çº¹
        await navigator.credentials.get(this.touchIDLoginOptions);
        // è°ƒç”¨æŒ‡çº¹ç™»å½•æ¥å£
        this.$api.touchIdLogingAPI
          .touchIdLogin({
            touchId: touchId,
            certificate: certificate
          })
          .then((res: responseDataType) => {
            if (res.code == 0) {
              // å­˜å‚¨å½“å‰ç”¨æˆ·ä¿¡æ¯
              localStorage.setItem("token", res.data.token);
              localStorage.setItem("refreshToken", res.data.refreshToken);
              localStorage.setItem("profilePicture", res.data.avatarSrc);
              localStorage.setItem("userID", res.data.userID);
              localStorage.setItem("username", res.data.username);
              const certificate = res.data.certificate;
              localStorage.setItem("certificate", certificate);
              // è·³è½¬æ¶ˆæ¯ç»„ä»¶
              this.$router.push({
                name: "message"
              });
              return;
            }
            // åˆ‡å›ç™»å½•ç•Œé¢
            this.isLoginStatus = loginStatusEnum.NOT_LOGGED_IN;
            alert(res.msg);
          });
      }
    }
å¤åˆ¶ä»£ç 
æ³¨æ„âš ï¸ï¼šæ³¨å†Œæ–°çš„æŒ‡çº¹åï¼Œæ—§çš„Touch idå°±ä¼šå¤±æ•ˆï¼Œåªèƒ½é€šè¿‡æ–°çš„Touch IDæ¥ç™»å½•ï¼Œå¦åˆ™ç³»ç»Ÿæ— æ³•è°ƒèµ·æŒ‡çº¹è®¾å¤‡ï¼Œä¼šæŠ¥é”™ï¼šè®¤è¯å‡ºäº†ç‚¹é—®é¢˜ã€‚

æ•´åˆç°æœ‰ç™»å½•é€»è¾‘
å®Œæˆä¸Šè¿°æ­¥éª¤åï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†æ•´ä¸ªæŒ‡çº¹çš„æ³¨å†Œã€ç™»å½•çš„é€»è¾‘ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å°†å…¶ä¸ç°æœ‰ç™»å½•è¿›è¡Œæ•´åˆã€‚

è°ƒç”¨æŒ‡çº¹æ³¨å†Œ
å½“ç”¨æˆ·ä½¿ç”¨ç”¨æˆ·åã€å¯†ç æˆ–è€…ç¬¬ä¸‰æ–¹å¹³å°æˆæƒç™»å½•æˆåŠŸåï¼Œæˆ‘ä»¬å°±è°ƒç”¨æŒ‡çº¹æ³¨å†Œå‡½æ•°ï¼Œæç¤ºç”¨æˆ·æ˜¯å¦å¯¹æœ¬ç½‘ç«™è¿›è¡Œæˆæƒï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

 authLogin: function(state: string, code: string, platform: string) {
      this.$api.authLoginAPI
        .authorizeLogin({
          state: state,
          code: code,
          platform: platform
        })
        .then(async (res: responseDataType) => {
          if (res.code == 0) {
            //  ... æˆæƒç™»å½•æˆåŠŸï¼Œå…¶ä»–ä»£ç çœç•¥ ... //
            // ä¿å­˜ç”¨æˆ·å‡­è¯ï¼Œç”¨äºæŒ‡çº¹ç™»å½•
            const certificate = res.data.certificate;
            localStorage.setItem("certificate", certificate);
            // æ ¡éªŒè®¾å¤‡æ˜¯å¦æ”¯æŒtouchID
            const hasTouchID = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
            if (hasTouchID) {
              //  ... å…¶ä»–ä»£ç çœç•¥ ... //
              // è·å–Touch IDï¼Œæ£€æµ‹ç”¨æˆ·æ˜¯å¦å·²æˆæƒæœ¬ç½‘ç«™æŒ‡çº¹ç™»å½•
              this.$api.touchIdLogingAPI
                .getTouchID({
                  userId: userId
                })
                .then(async (res: responseDataType) => {
                  if (res.code !== 0) {
                    // touchIdä¸å­˜åœ¨, è¯¢é—®ç”¨æˆ·æ˜¯å¦æ³¨å†ŒtouchId
                    await this.touchIDRegistered(username, userId, certificate);
                  }
                  // ä¿å­˜touchid
                  localStorage.setItem("touchId", res.data);
                  // è·³è½¬æ¶ˆæ¯ç»„ä»¶
                  await this.$router.push({
                    name: "message"
                  });
                });
              return;
            }
            // è®¾å¤‡ä¸æ”¯æŒtouchIDï¼Œç›´æ¥è·³è½¬æ¶ˆæ¯ç»„ä»¶
            await this.$router.push({
              name: "message"
            });
            return;
          }
          // ç™»å½•å¤±è´¥ï¼Œåˆ‡å›ç™»å½•ç•Œé¢
          this.isLoginStatus = loginStatusEnum.NOT_LOGGED_IN;
          alert(res.msg);
        });
    }
å¤åˆ¶ä»£ç 
æœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š





æ¯æ¬¡ç¬¬ä¸‰æ–¹å¹³å°æˆæƒç™»å½•æ—¶éƒ½ä¼šæ£€æµ‹å½“å‰ç”¨æˆ·æ˜¯å¦å·²æˆæƒæœ¬ç½‘ç«™ï¼Œå¦‚æœå·²æˆæƒåˆ™å°†Touch IDä¿å­˜è‡³æœ¬åœ°ï¼Œç”¨äºé€šè¿‡æŒ‡çº¹ç›´æ¥ç™»å½•ã€‚

è°ƒç”¨æŒ‡çº¹ç™»å½•
å½“ç™»å½•é¡µé¢åŠ è½½å®Œæ¯•1såï¼Œæˆ‘ä»¬ä»ç”¨æˆ·æœ¬åœ°å–å‡ºç”¨æˆ·å‡­è¯ä¸Touch IDï¼Œå¦‚æœå­˜åœ¨åˆ™æç¤ºç”¨æˆ·æ˜¯å¦éœ€è¦é€šè¿‡æŒ‡çº¹æ¥ç™»å½•ç³»ç»Ÿï¼Œå…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

  mounted() {
    const touchId = localStorage.getItem("touchId");
    const certificate = localStorage.getItem("certificate");
    // å¦‚æœtouchIdå­˜åœ¨ï¼Œåˆ™è°ƒç”¨æŒ‡çº¹ç™»å½•
    if (touchId && certificate) {
      // æç¤ºç”¨æˆ·æ˜¯å¦éœ€è¦touchIdç™»å½•
      setTimeout(() => {
        if (window.confirm("æ‚¨å·²æˆæƒæœ¬ç½‘ç«™é€šè¿‡æŒ‡çº¹ç™»å½•ï¼Œæ˜¯å¦ç«‹å³ç™»å½•ï¼Ÿ")) {
          this.touchIDLogin(certificate, touchId);
        }
      }, 1000);
    }
  }
å¤åˆ¶ä»£ç 
æœ€ç»ˆæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š





é¡¹ç›®åœ°å€
æœ¬æ–‡ä»£ç çš„å®Œæ•´åœ°å€è¯·ç§»æ­¥ï¼šLogin.vue

åœ¨çº¿ä½“éªŒåœ°å€ï¼šchat-system
é¡¹ç›®GitHubåœ°å€ï¼šchat-system-github
å†™åœ¨æœ€å
æœ€è¿‘æ‰“ç®—æ¢å·¥ä½œï¼Œæœ‰æ²¡æœ‰å¹¿å·è¿™è¾¹çš„å…¬å¸å¯ä»¥å†…æ¨æˆ‘å‘€ğŸ˜ï¼Œæˆ‘çš„å¾®ä¿¡ï¼šBaymax-kt

æ–‡ä¸­å¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæŒ‡æ­£ï¼Œå¦‚æœè¿™ç¯‡æ–‡ç« å¸®åˆ°äº†ä½ ï¼Œæ¬¢è¿ç‚¹èµå’Œå…³æ³¨ğŸ˜Š
æœ¬æ–‡é¦–å‘äºæ˜é‡‘ï¼Œæœªç»è®¸å¯ç¦æ­¢è½¬è½½ğŸ’Œ
